<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Health Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f3f4f6;
            color: #1f2937;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        .header {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .header h1 {
            font-size: 1.875rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        
        .header p {
            color: #6b7280;
        }
        
        .header-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .btn-blue {
            background: #2563eb;
            color: white;
        }
        
        .btn-blue:hover {
            background: #1d4ed8;
        }
        
        .btn-green {
            background: #059669;
            color: white;
        }
        
        .btn-green:hover {
            background: #047857;
        }
        
        .btn-purple {
            background: #7c3aed;
            color: white;
        }
        
        .btn-purple:hover {
            background: #6d28d9;
        }
        
        .btn-gray {
            background: #9ca3af;
            color: white;
        }
        
        .btn-gray:hover {
            background: #6b7280;
        }
        
        .btn-red {
            background: #dc2626;
            color: white;
        }
        
        .btn-red:hover {
            background: #b91c1c;
        }
        
        .parent-selector {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .parent-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .parent-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .parent-btn.inactive {
            background: #f3f4f6;
            color: #4b5563;
        }
        
        .parent-btn.inactive:hover {
            background: #e5e7eb;
        }
        
        .parent-btn.mom {
            background: #ec4899;
            color: white;
        }
        
        .parent-btn.dad {
            background: #2563eb;
            color: white;
        }
        
        .main-content {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            background: #f3f4f6;
            color: #4b5563;
        }
        
        .tab:hover {
            background: #e5e7eb;
        }
        
        .tab.active {
            background: #2563eb;
            color: white;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .metric-card {
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid;
        }
        
        .metric-card.blue {
            background: #dbeafe;
            border-color: #2563eb;
        }
        
        .metric-card.green {
            background: #d1fae5;
            border-color: #10b981;
        }
        
        .metric-card.purple {
            background: #ede9fe;
            border-color: #8b5cf6;
        }
        
        .metric-card.red {
            background: #fee2e2;
            border-color: #ef4444;
        }
        
        .metric-label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .metric-value {
            font-size: 1.875rem;
            font-weight: bold;
        }
        
        .metric-info {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        
        .form-container {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .lab-result-card {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        .lab-result-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .lab-result-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .lab-result-date {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .lab-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }
        
        .test-result {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 2px solid;
            position: relative;
        }
        
        .test-result.normal {
            background: #d1fae5;
            border-color: #34d399;
        }
        
        .test-result.low {
            background: #dbeafe;
            border-color: #60a5fa;
        }
        
        .test-result.high {
            background: #fee2e2;
            border-color: #f87171;
        }
        
        .test-name {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .test-value {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .test-unit {
            font-size: 0.75rem;
            color: #4b5563;
        }
        
        .test-status {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            display: inline-block;
            margin-top: 0.5rem;
        }
        
        .test-status.normal {
            background: #10b981;
            color: white;
        }
        
        .test-status.low {
            background: #3b82f6;
            color: white;
        }
        
        .test-status.high {
            background: #ef4444;
            color: white;
        }
        
        .test-range {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .medication-card,
        .appointment-card,
        .note-card {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            position: relative;
        }
        
        .delete-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
        }
        
        .delete-btn:hover {
            color: #dc2626;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        
        .close-modal:hover {
            color: #374151;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .alert.success {
            background: #d1fae5;
            border: 1px solid #34d399;
            color: #065f46;
        }
        
        .alert.warning {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            color: #92400e;
        }
        
        .alert.error {
            background: #fee2e2;
            border: 1px solid #f87171;
            color: #991b1b;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }
        
        .settings-panel {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .settings-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .settings-section:last-child {
            border-bottom: none;
        }
        
        .lab-template-item {
            background: #f3f4f6;
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 0.5rem;
            align-items: center;
        }
        
        .lab-template-item input {
            padding: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        
        .kidney-panel {
            padding: 1.5rem;
            border-radius: 0.5rem;
            border-left: 4px solid;
            margin-bottom: 1.5rem;
        }
        
        .kidney-panel.good {
            background: #d1fae5;
            border-color: #10b981;
        }
        
        .kidney-panel.warning {
            background: #fef3c7;
            border-color: #f59e0b;
        }
        
        .kidney-panel.danger {
            background: #fee2e2;
            border-color: #ef4444;
        }
        
        .kidney-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .kidney-score-value {
            font-size: 1.875rem;
            font-weight: bold;
        }
        
        .progress-bar {
            width: 100%;
            height: 0.75rem;
            background: #e5e7eb;
            border-radius: 0.375rem;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        .progress-fill.good {
            background: #10b981;
        }
        
        .progress-fill.warning {
            background: #f59e0b;
        }
        
        .progress-fill.danger {
            background: #ef4444;
        }
        
        @media (max-width: 640px) {
            .header-content {
                flex-direction: column;
                align-items: start;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .parent-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <h1 id="appTitle">Parent Health Tracker</h1>
                    <p id="appSubtitle">Comprehensive lab results and health monitoring</p>
                </div>
                <div class="header-buttons">
                    <button class="btn btn-green" onclick="toggleSharing()">
                        <span id="sharingBtn">Enable Sharing</span>
                    </button>
                    <button class="btn btn-purple" onclick="showSettings()">
                        <span id="customizeBtn">Customize</span>
                    </button>
                    <button class="btn btn-blue" onclick="exportToCSV()">
                        <span id="exportBtn">Export</span>
                    </button>
                </div>
            </div>
            <div id="sharingAlert" style="display: none;" class="alert success" style="margin-top: 1rem;">
                <span id="sharingMsg">Sharing is active - your caregiver can access this dashboard</span>
            </div>
        </div>
        
        <!-- Parent Selector -->
        <div class="parent-selector">
            <div class="parent-buttons">
                <button class="parent-btn mom" onclick="selectParent('mom')" id="momBtn">
                    <span id="momLabel">Mom</span>
                </button>
                <button class="parent-btn inactive" onclick="selectParent('dad')" id="dadBtn">
                    <span id="dadLabel">Dad</span>
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')" id="dashboardTab">
                    <span id="dashboardLabel">Dashboard</span>
                </button>
                <button class="tab" onclick="switchTab('labs')" id="labsTab">
                    <span id="labResultsLabel">Lab Results</span>
                </button>
                <button class="tab" onclick="switchTab('medications')" id="medicationsTab">
                    <span id="medicationsLabel">Medications</span>
                </button>
                <button class="tab" onclick="switchTab('appointments')" id="appointmentsTab">
                    <span id="appointmentsLabel">Appointments</span>
                </button>
                <button class="tab" onclick="switchTab('notes')" id="notesTab">
                    <span id="notesLabel">Notes</span>
                </button>
            </div>
            
            <!-- Add New Button -->
            <button id="addNewBtn" class="btn btn-green" onclick="showAddForm()" style="display: none; margin-bottom: 1rem;">
                <span id="addNewLabel">Add New</span>
            </button>
            
            <!-- Content Area -->
            <div id="contentArea"></div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Share Dashboard</h3>
                <button class="close-modal" onclick="closeShareModal()">&times;</button>
            </div>
            <div class="alert success">
                <strong>Sharing is now enabled!</strong><br>
                Anyone with this link can view and edit the health data.
            </div>
            <div class="form-group">
                <label>Share this link with your caregiver:</label>
                <input type="text" id="shareLink" readonly>
                <button class="btn btn-blue" onclick="copyShareLink()" style="margin-top: 0.5rem;">Copy Link</button>
            </div>
            <div class="alert warning">
                <strong>Important:</strong> Anyone with this link can access and modify the health data. Only share with trusted caregivers.
            </div>
        </div>
    </div>

    <script>
        // State management
        let currentParent = 'mom';
        let currentTab = 'dashboard';
        let labResults = { mom: [], dad: [] };
        let medications = { mom: [], dad: [] };
        let appointments = { mom: [], dad: [] };
        let notes = { mom: [], dad: [] };
        let sharingEnabled = false;
        let language = 'en';
        let labTemplates = {
            'Complete Blood Count (CBC)': [
                { name: 'WBC', unit: 'K/uL', refMin: 4.5, refMax: 11.0 },
                { name: 'RBC', unit: 'M/uL', refMin: 4.5, refMax: 5.9 },
                { name: 'Hemoglobin', unit: 'g/dL', refMin: 13.5, refMax: 17.5 },
                { name: 'Hematocrit', unit: '%', refMin: 38.8, refMax: 50.0 },
                { name: 'Platelets', unit: 'K/uL', refMin: 150, refMax: 400 }
            ],
            'Metabolic Panel (CMP)': [
                { name: 'Glucose', unit: 'mg/dL', refMin: 70, refMax: 100 },
                { name: 'BUN', unit: 'mg/dL', refMin: 7, refMax: 20 },
                { name: 'Creatinine', unit: 'mg/dL', refMin: 0.7, refMax: 1.3 },
                { name: 'eGFR', unit: 'mL/min/1.73m²', refMin: 60, refMax: 120 },
                { name: 'Sodium', unit: 'mmol/L', refMin: 136, refMax: 145 },
                { name: 'Potassium', unit: 'mmol/L', refMin: 3.5, refMax: 5.0 }
            ],
            'Lipid Panel': [
                { name: 'Total Cholesterol', unit: 'mg/dL', refMin: 0, refMax: 200 },
                { name: 'LDL Cholesterol', unit: 'mg/dL', refMin: 0, refMax: 100 },
                { name: 'HDL Cholesterol', unit: 'mg/dL', refMin: 40, refMax: 999 },
                { name: 'Triglycerides', unit: 'mg/dL', refMin: 0, refMax: 150 }
            ],
            'Thyroid Function': [
                { name: 'TSH', unit: 'mIU/L', refMin: 0.4, refMax: 4.0 },
                { name: 'Free T4', unit: 'ng/dL', refMin: 0.8, refMax: 1.8 },
                { name: 'Free T3', unit: 'pg/mL', refMin: 2.3, refMax: 4.2 }
            ],
            'Kidney Function Panel': [
                { name: 'Creatinine', unit: 'mg/dL', refMin: 0.7, refMax: 1.3 },
                { name: 'BUN', unit: 'mg/dL', refMin: 7, refMax: 20 },
                { name: 'eGFR', unit: 'mL/min/1.73m²', refMin: 60, refMax: 120 },
                { name: 'BUN/Creatinine Ratio', unit: 'ratio', refMin: 10, refMax: 20 },
                { name: 'Albumin', unit: 'g/dL', refMin: 3.5, refMax: 5.5 },
                { name: 'Uric Acid', unit: 'mg/dL', refMin: 3.5, refMax: 7.2 }
            ]
        };

        const translations = {
            en: {
                appTitle: "Parent Health Tracker",
                appSubtitle: "Comprehensive lab results and health monitoring",
                dashboard: "Dashboard",
                labResults: "Lab Results",
                medications: "Medications",
                appointments: "Appointments",
                notes: "Notes",
                mom: "Mom",
                dad: "Dad",
                addNew: "Add New",
                export: "Export",
                customize: "Customize",
                enableSharing: "Enable Sharing",
                sharingEnabled: "Sharing Enabled",
                totalLabTests: "Total Lab Tests",
                activeMedications: "Active Medications",
                upcomingAppointments: "Upcoming Appointments",
                abnormalValues: "Abnormal Values",
                allNormal: "All normal",
                needsAttention: "Needs attention",
                last: "Last",
                currentlyTaking: "Currently taking",
                next: "Next"
            },
            th: {
                appTitle: "ติดตามสุขภาพพ่อแม่",
                appSubtitle: "ติดตามผลแลปและสุขภาพอย่างครบถ้วน",
                dashboard: "แดชบอร์ด",
                labResults: "ผลแลป",
                medications: "ยา",
                appointments: "นัดหมาย",
                notes: "บันทึก",
                mom: "แม่",
                dad: "พ่อ",
                addNew: "เพิ่มใหม่",
                export: "ส่งออก",
                customize: "ปรับแต่ง",
                enableSharing: "เปิดการแชร์",
                sharingEnabled: "กำลังแชร์",
                totalLabTests: "ตรวจแลปทั้งหมด",
                activeMedications: "ยาที่ใช้อยู่",
                upcomingAppointments: "นัดหมายที่จะถึง",
                abnormalValues: "ค่าผิดปกติ",
                allNormal: "ปกติทั้งหมด",
                needsAttention: "ต้องดูแล",
                last: "ล่าสุด",
                currentlyTaking: "กำลังใช้",
                next: "ถัดไป"
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateUI();
        });

        // Translation helper
        function t(key) {
            return translations[language][key] || key;
        }

        function updateTranslations() {
            document.getElementById('appTitle').textContent = t('appTitle');
            document.getElementById('appSubtitle').textContent = t('appSubtitle');
            document.getElementById('dashboardLabel').textContent = t('dashboard');
            document.getElementById('labResultsLabel').textContent = t('labResults');
            document.getElementById('medicationsLabel').textContent = t('medications');
            document.getElementById('appointmentsLabel').textContent = t('appointments');
            document.getElementById('notesLabel').textContent = t('notes');
            document.getElementById('momLabel').textContent = t('mom');
            document.getElementById('dadLabel').textContent = t('dad');
            document.getElementById('addNewLabel').textContent = t('addNew');
            document.getElementById('exportBtn').textContent = t('export');
            document.getElementById('customizeBtn').textContent = t('customize');
            document.getElementById('sharingBtn').textContent = sharingEnabled ? t('sharingEnabled') : t('enableSharing');
        }

        // Storage functions
        async function loadData() {
            try {
                if (typeof window.storage !== 'undefined') {
                    const sharingResult = await window.storage.get('sharing-enabled', true);
                    sharingEnabled = sharingResult?.value === 'true';

                    const labsResult = await window.storage.get('lab-results', sharingEnabled);
                    const medsResult = await window.storage.get('medications', sharingEnabled);
                    const aptsResult = await window.storage.get('appointments', sharingEnabled);
                    const notesResult = await window.storage.get('notes', sharingEnabled);
                    const langResult = await window.storage.get('language', sharingEnabled);

                    if (labsResult?.value) labResults = JSON.parse(labsResult.value);
                    if (medsResult?.value) medications = JSON.parse(medsResult.value);
                    if (aptsResult?.value) appointments = JSON.parse(aptsResult.value);
                    if (notesResult?.value) notes = JSON.parse(notesResult.value);
                    if (langResult?.value) language = langResult.value;
                } else {
                    // Fallback to localStorage
                    const savedData = localStorage.getItem('healthTrackerData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        labResults = data.labResults || labResults;
                        medications = data.medications || medications;
                        appointments = data.appointments || appointments;
                        notes = data.notes || notes;
                        sharingEnabled = data.sharingEnabled || false;
                        language = data.language || 'en';
                    }
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
            updateTranslations();
            updateUI();
        }

        async function saveData() {
            try {
                if (typeof window.storage !== 'undefined') {
                    await window.storage.set('lab-results', JSON.stringify(labResults), sharingEnabled);
                    await window.storage.set('medications', JSON.stringify(medications), sharingEnabled);
                    await window.storage.set('appointments', JSON.stringify(appointments), sharingEnabled);
                    await window.storage.set('notes', JSON.stringify(notes), sharingEnabled);
                    await window.storage.set('language', language, sharingEnabled);
                    await window.storage.set('sharing-enabled', String(sharingEnabled), true);
                } else {
                    // Fallback to localStorage
                    const data = {
                        labResults,
                        medications,
                        appointments,
                        notes,
                        sharingEnabled,
                        language
                    };
                    localStorage.setItem('healthTrackerData', JSON.stringify(data));
                }
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        // UI Functions
        function selectParent(parent) {
            currentParent = parent;
            document.getElementById('momBtn').className = parent === 'mom' ? 'parent-btn mom' : 'parent-btn inactive';
            document.getElementById('dadBtn').className = parent === 'dad' ? 'parent-btn dad' : 'parent-btn inactive';
            updateUI();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            
            const addBtn = document.getElementById('addNewBtn');
            if (tab !== 'dashboard') {
                addBtn.style.display = 'block';
            } else {
                addBtn.style.display = 'none';
            }
            
            updateUI();
        }

        function updateUI() {
            const contentArea = document.getElementById('contentArea');
            
            switch(currentTab) {
                case 'dashboard':
                    showDashboard();
                    break;
                case 'labs':
                    showLabResults();
                    break;
                case 'medications':
                    showMedications();
                    break;
                case 'appointments':
                    showAppointments();
                    break;
                case 'notes':
                    showNotes();
                    break;
            }
            
            // Update sharing status
            if (sharingEnabled) {
                document.getElementById('sharingAlert').style.display = 'block';
                document.getElementById('sharingBtn').textContent = t('sharingEnabled');
            } else {
                document.getElementById('sharingAlert').style.display = 'none';
                document.getElementById('sharingBtn').textContent = t('enableSharing');
            }
        }

        function showDashboard() {
            const labs = labResults[currentParent];
            const meds = medications[currentParent];
            const apts = appointments[currentParent].filter(apt => new Date(apt.date) >= new Date());
            
            // Count abnormal values
            let abnormalCount = 0;
            labs.forEach(lab => {
                lab.results.forEach(result => {
                    if (result.value < result.refMin || result.value > result.refMax) {
                        abnormalCount++;
                    }
                });
            });
            
            const latestLab = labs.length > 0 ? 
                labs.sort((a, b) => new Date(b.date) - new Date(a.date))[0] : null;
            const nextApt = apts.length > 0 ? 
                apts.sort((a, b) => new Date(a.date) - new Date(b.date))[0] : null;
            
            let html = `
                <div class="dashboard-grid">
                    <div class="metric-card blue">
                        <div class="metric-label">${t('totalLabTests')}</div>
                        <div class="metric-value">${labs.length}</div>
                        <div class="metric-info">${latestLab ? `${t('last')}: ${latestLab.date}` : ''}</div>
                    </div>
                    <div class="metric-card green">
                        <div class="metric-label">${t('activeMedications')}</div>
                        <div class="metric-value">${meds.length}</div>
                        <div class="metric-info">${t('currentlyTaking')}</div>
                    </div>
                    <div class="metric-card purple">
                        <div class="metric-label">${t('upcomingAppointments')}</div>
                        <div class="metric-value">${apts.length}</div>
                        <div class="metric-info">${nextApt ? `${t('next')}: ${new Date(nextApt.date).toLocaleDateString()}` : ''}</div>
                    </div>
                    <div class="metric-card ${abnormalCount > 0 ? 'red' : 'green'}">
                        <div class="metric-label">${t('abnormalValues')}</div>
                        <div class="metric-value">${abnormalCount}</div>
                        <div class="metric-info">${abnormalCount === 0 ? t('allNormal') : t('needsAttention')}</div>
                    </div>
                </div>
            `;
            
            // Show latest results if available
            if (latestLab) {
                html += `<h3 style="margin-top: 2rem;">Latest Test Results - ${latestLab.testType}</h3>`;
                html += `<div class="lab-results-grid">`;
                latestLab.results.forEach(result => {
                    const status = result.value < result.refMin ? 'low' : 
                                  result.value > result.refMax ? 'high' : 'normal';
                    const statusText = status === 'normal' ? '✓ Normal' : 
                                      status === 'low' ? '↓ Low' : '↑ High';
                    
                    html += `
                        <div class="test-result ${status}">
                            <div class="test-name">${result.name}</div>
                            <div class="test-value">${result.value}</div>
                            <div class="test-unit">${result.unit}</div>
                            <div class="test-status ${status}">${statusText}</div>
                            <div class="test-range">Normal: ${result.refMin}-${result.refMax}</div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function showLabResults() {
            const labs = labResults[currentParent];
            let html = '';
            
            if (labs.length === 0) {
                html = '<div class="empty-state">No lab results yet</div>';
            } else {
                labs.sort((a, b) => new Date(b.date) - new Date(a.date));
                labs.forEach(lab => {
                    html += `
                        <div class="lab-result-card">
                            <div class="lab-result-header">
                                <div>
                                    <div class="lab-result-title">${lab.testType}</div>
                                    <div class="lab-result-date">${lab.date}</div>
                                </div>
                                <button class="delete-btn" onclick="deleteLabResult(${lab.id})">×</button>
                            </div>
                            <div class="lab-results-grid">
                    `;
                    
                    lab.results.forEach(result => {
                        const status = result.value < result.refMin ? 'low' : 
                                      result.value > result.refMax ? 'high' : 'normal';
                        const statusText = status === 'normal' ? '✓ Normal' : 
                                          status === 'low' ? '↓ Low' : '↑ High';
                        
                        html += `
                            <div class="test-result ${status}">
                                <div class="test-name">${result.name}</div>
                                <div class="test-value">${result.value}</div>
                                <div class="test-unit">${result.unit}</div>
                                <div class="test-status ${status}">${statusText}</div>
                                <div class="test-range">Normal: ${result.refMin}-${result.refMax}</div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function showMedications() {
            const meds = medications[currentParent];
            let html = '';
            
            if (meds.length === 0) {
                html = '<div class="empty-state">No medications added yet</div>';
            } else {
                meds.forEach(med => {
                    html += `
                        <div class="medication-card">
                            <button class="delete-btn" onclick="deleteMedication(${med.id})">×</button>
                            <div style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">${med.name}</div>
                            <div style="color: #4b5563;">${med.dosage} - ${med.frequency}</div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">Take at ${med.time}</div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function showAppointments() {
            const apts = appointments[currentParent];
            let html = '';
            
            if (apts.length === 0) {
                html = '<div class="empty-state">No appointments scheduled</div>';
            } else {
                apts.forEach(apt => {
                    html += `
                        <div class="appointment-card">
                            <button class="delete-btn" onclick="deleteAppointment(${apt.id})">×</button>
                            <div style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">${apt.type}</div>
                            <div style="color: #4b5563;">with ${apt.doctor}</div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">${apt.date}</div>
                            ${apt.notes ? `<div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">${apt.notes}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function showNotes() {
            const notesList = notes[currentParent];
            let html = '';
            
            if (notesList.length === 0) {
                html = '<div class="empty-state">No notes added yet</div>';
            } else {
                notesList.forEach(note => {
                    html += `
                        <div class="note-card">
                            <button class="delete-btn" onclick="deleteNote(${note.id})">×</button>
                            <div style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">${note.title}</div>
                            <span style="font-size: 0.75rem; background: #dbeafe; color: #1e40af; padding: 0.125rem 0.5rem; border-radius: 0.25rem;">${note.category}</span>
                            <div style="color: #4b5563; margin-top: 0.5rem;">${note.content}</div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">${new Date(note.timestamp).toLocaleString()}</div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        // Add forms
        function showAddForm() {
            const contentArea = document.getElementById('contentArea');
            
            switch(currentTab) {
                case 'labs':
                    showLabForm();
                    break;
                case 'medications':
                    showMedicationForm();
                    break;
                case 'appointments':
                    showAppointmentForm();
                    break;
                case 'notes':
                    showNoteForm();
                    break;
            }
        }

        function showLabForm() {
            const testTypes = Object.keys(labTemplates);
            let html = `
                <div class="form-container">
                    <h3 style="margin-bottom: 1rem;">Add Lab Results</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="labDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>Test Type</label>
                            <select id="labTestType" onchange="updateLabTestFields()">
                                ${testTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div id="labTestFields" style="margin-top: 1rem;"></div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-blue" onclick="saveLabResult()">Save</button>
                        <button class="btn btn-gray" onclick="updateUI()" style="margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = html;
            updateLabTestFields();
        }

        function updateLabTestFields() {
            const testType = document.getElementById('labTestType').value;
            const template = labTemplates[testType];
            let html = '<h4 style="margin-bottom: 0.5rem;">Enter Results</h4>';
            
            template.forEach((test, index) => {
                html += `
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.75rem; background: #f3f4f6; border-radius: 0.25rem;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; font-size: 0.875rem;">${test.name}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">Ref: ${test.refMin} - ${test.refMax} ${test.unit}</div>
                        </div>
                        <input type="number" step="0.01" id="labValue_${index}" placeholder="Value" style="width: 100px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem;">
                        <span style="font-size: 0.875rem; color: #6b7280; width: 60px;">${test.unit}</span>
                    </div>
                `;
            });
            
            document.getElementById('labTestFields').innerHTML = html;
        }

        function saveLabResult() {
            const date = document.getElementById('labDate').value;
            const testType = document.getElementById('labTestType').value;
            const template = labTemplates[testType];
            const results = [];
            
            template.forEach((test, index) => {
                const value = parseFloat(document.getElementById(`labValue_${index}`).value);
                if (!isNaN(value)) {
                    results.push({
                        name: test.name,
                        value: value,
                        unit: test.unit,
                        refMin: test.refMin,
                        refMax: test.refMax
                    });
                }
            });
            
            if (results.length > 0) {
                const newLab = {
                    id: Date.now(),
                    date: date,
                    testType: testType,
                    results: results
                };
                
                labResults[currentParent].push(newLab);
                saveData();
                updateUI();
            }
        }

        function showMedicationForm() {
            let html = `
                <div class="form-container">
                    <h3 style="margin-bottom: 1rem;">Add Medication</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Medication Name</label>
                            <input type="text" id="medName">
                        </div>
                        <div class="form-group">
                            <label>Dosage</label>
                            <input type="text" id="medDosage" placeholder="e.g., 10mg">
                        </div>
                        <div class="form-group">
                            <label>Frequency</label>
                            <select id="medFrequency">
                                <option>Once daily</option>
                                <option>Twice daily</option>
                                <option>Three times daily</option>
                                <option>As needed</option>
                                <option>Weekly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Time</label>
                            <input type="time" id="medTime" value="08:00">
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-blue" onclick="saveMedication()">Save</button>
                        <button class="btn btn-gray" onclick="updateUI()" style="margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function saveMedication() {
            const name = document.getElementById('medName').value;
            const dosage = document.getElementById('medDosage').value;
            const frequency = document.getElementById('medFrequency').value;
            const time = document.getElementById('medTime').value;
            
            if (name && dosage) {
                const newMed = {
                    id: Date.now(),
                    name: name,
                    dosage: dosage,
                    frequency: frequency,
                    time: time
                };
                
                medications[currentParent].push(newMed);
                saveData();
                updateUI();
            }
        }

        function showAppointmentForm() {
            let html = `
                <div class="form-container">
                    <h3 style="margin-bottom: 1rem;">Add Appointment</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Date & Time</label>
                            <input type="datetime-local" id="aptDate">
                        </div>
                        <div class="form-group">
                            <label>Doctor</label>
                            <input type="text" id="aptDoctor">
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label>Appointment Type</label>
                            <input type="text" id="aptType" placeholder="e.g., Cardiology, General Checkup">
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label>Notes</label>
                            <textarea id="aptNotes" rows="3"></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-blue" onclick="saveAppointment()">Save</button>
                        <button class="btn btn-gray" onclick="updateUI()" style="margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function saveAppointment() {
            const date = document.getElementById('aptDate').value;
            const doctor = document.getElementById('aptDoctor').value;
            const type = document.getElementById('aptType').value;
            const notes = document.getElementById('aptNotes').value;
            
            if (date && doctor && type) {
                const newApt = {
                    id: Date.now(),
                    date: date,
                    doctor: doctor,
                    type: type,
                    notes: notes
                };
                
                appointments[currentParent].push(newApt);
                saveData();
                updateUI();
            }
        }

        function showNoteForm() {
            let html = `
                <div class="form-container">
                    <h3 style="margin-bottom: 1rem;">Add Note</h3>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="noteTitle">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="noteCategory">
                            <option>General</option>
                            <option>Symptoms</option>
                            <option>Diet</option>
                            <option>Exercise</option>
                            <option>Concerns</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Content</label>
                        <textarea id="noteContent" rows="4"></textarea>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-blue" onclick="saveNote()">Save</button>
                        <button class="btn btn-gray" onclick="updateUI()" style="margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function saveNote() {
            const title = document.getElementById('noteTitle').value;
            const category = document.getElementById('noteCategory').value;
            const content = document.getElementById('noteContent').value;
            
            if (title && content) {
                const newNote = {
                    id: Date.now(),
                    title: title,
                    category: category,
                    content: content,
                    timestamp: new Date().toISOString()
                };
                
                notes[currentParent].push(newNote);
                saveData();
                updateUI();
            }
        }

        // Delete functions
        function deleteLabResult(id) {
            labResults[currentParent] = labResults[currentParent].filter(l => l.id !== id);
            saveData();
            updateUI();
        }

        function deleteMedication(id) {
            medications[currentParent] = medications[currentParent].filter(m => m.id !== id);
            saveData();
            updateUI();
        }

        function deleteAppointment(id) {
            appointments[currentParent] = appointments[currentParent].filter(a => a.id !== id);
            saveData();
            updateUI();
        }

        function deleteNote(id) {
            notes[currentParent] = notes[currentParent].filter(n => n.id !== id);
            saveData();
            updateUI();
        }

        // Settings
        function showSettings() {
            let html = `
                <div class="settings-panel">
                    <h3 style="margin-bottom: 1rem;">Settings</h3>
                    
                    <div class="settings-section">
                        <h4 style="margin-bottom: 0.5rem;">Language</h4>
                        <select onchange="changeLanguage(this.value)" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem;">
                            <option value="en" ${language === 'en' ? 'selected' : ''}>English</option>
                            <option value="th" ${language === 'th' ? 'selected' : ''}>ภาษาไทย (Thai)</option>
                        </select>
                    </div>
                    
                    <div class="settings-section">
                        <h4 style="margin-bottom: 0.5rem;">Lab Test Templates</h4>
                        <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">Customize reference ranges for each test</p>
                        <p style="font-size: 0.75rem; background: #dbeafe; padding: 0.75rem; border-radius: 0.25rem; color: #1e40af;">
                            You can customize the test panels and reference ranges in the full version
                        </p>
                    </div>
                    
                    <button class="btn btn-gray" onclick="updateUI()" style="margin-top: 1rem;">Close</button>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function changeLanguage(lang) {
            language = lang;
            updateTranslations();
            saveData();
        }

        // Sharing
        async function toggleSharing() {
            if (!sharingEnabled) {
                sharingEnabled = true;
                await saveData();
                showShareModal();
            } else {
                if (confirm('This will make the data private again. Your caregiver will lose access. Continue?')) {
                    sharingEnabled = false;
                    await saveData();
                }
            }
            updateUI();
        }

        function showShareModal() {
            document.getElementById('shareLink').value = window.location.href;
            document.getElementById('shareModal').classList.add('show');
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('show');
        }

        function copyShareLink() {
            const input = document.getElementById('shareLink');
            input.select();
            document.execCommand('copy');
            alert('Link copied to clipboard!');
        }

        // Export
        function exportToCSV() {
            const parent = currentParent === 'mom' ? 'Mom' : 'Dad';
            let csv = `${parent}'s Health Data Export\nGenerated: ${new Date().toLocaleString()}\n\n`;
            
            csv += 'LAB RESULTS\n';
            csv += 'Date,Test Type,Test Name,Value,Unit,Reference Min,Reference Max,Status\n';
            labResults[currentParent].forEach(lab => {
                lab.results.forEach(result => {
                    const status = result.value < result.refMin ? 'Low' : 
                                  result.value > result.refMax ? 'High' : 'Normal';
                    csv += `${lab.date},${lab.testType},${result.name},${result.value},${result.unit},${result.refMin},${result.refMax},${status}\n`;
                });
            });
            
            csv += '\nMEDICATIONS\n';
            csv += 'Name,Dosage,Frequency,Time\n';
            medications[currentParent].forEach(med => {
                csv += `${med.name},${med.dosage},${med.frequency},${med.time}\n`;
            });
            
            csv += '\nAPPOINTMENTS\n';
            csv += 'Date,Doctor,Type,Notes\n';
            appointments[currentParent].forEach(apt => {
                csv += `${apt.date},${apt.doctor},${apt.type},"${apt.notes || ''}"\n`;
            });
            
            csv += '\nNOTES\n';
            csv += 'Date,Title,Category,Content\n';
            notes[currentParent].forEach(note => {
                csv += `${new Date(note.timestamp).toLocaleString()},"${note.title}",${note.category},"${note.content}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${parent}_Health_Data_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
</body>
</html>
