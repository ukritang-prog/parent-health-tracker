<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Health Tracker - Collaborative Edition</title>
    
    <!-- Firebase SDK -->
    const firebaseConfig = {
    apiKey: "your-actual-api-key",
    authDomain: "your-project.firebaseapp.com",
    databaseURL: "https://your-project.firebaseio.com",
    projectId: "your-project-id",
    storageBucket: "your-project.appspot.com",
    messagingSenderId: "your-sender-id",
    appId: "your-app-id"
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f3f4f6;
            color: #1f2937;
            line-height: 1.6;
        }
        
        /* Collaboration Header */
        .collab-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .collab-info {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .room-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .room-code {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            font-size: 1.125rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            color: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .active-users {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .active-user {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid white;
            background: #10b981;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        /* Activity Feed */
        .activity-feed {
            position: fixed;
            right: 20px;
            top: 100px;
            width: 300px;
            max-height: 400px;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 500;
            overflow: hidden;
            transition: transform 0.3s;
        }
        
        .activity-feed.collapsed {
            transform: translateX(320px);
        }
        
        .activity-header {
            background: #f3f4f6;
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .activity-list {
            max-height: 350px;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .activity-item {
            padding: 0.5rem;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }
        
        .activity-user {
            font-weight: bold;
            color: #667eea;
        }
        
        .activity-time {
            font-size: 0.75rem;
            color: #9ca3af;
        }
        
        .activity-toggle {
            position: fixed;
            right: 20px;
            top: 100px;
            background: #667eea;
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem 0 0 0.5rem;
            cursor: pointer;
            z-index: 501;
            transition: transform 0.3s;
        }
        
        .activity-toggle.shifted {
            transform: translateX(-300px);
        }
        
        /* Comments */
        .comment-section {
            margin-top: 1rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 0.5rem;
        }
        
        .comment {
            background: white;
            padding: 0.75rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .comment-author {
            font-weight: bold;
            color: #667eea;
        }
        
        .comment-time {
            font-size: 0.75rem;
            color: #9ca3af;
        }
        
        .comment-input {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .comment-input input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
        }
        
        /* Existing styles continue... */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        .header {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .btn-blue {
            background: #2563eb;
            color: white;
        }
        
        .btn-green {
            background: #059669;
            color: white;
        }
        
        .btn-purple {
            background: #7c3aed;
            color: white;
        }
        
        .btn-gray {
            background: #9ca3af;
            color: white;
        }
        
        .btn-red {
            background: #dc2626;
            color: white;
        }
        
        /* Animation for notifications */
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .sync-indicator {
            animation: pulse 2s infinite;
        }
        
        /* Continue with all other existing styles... */
        .parent-selector {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .parent-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .parent-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .parent-btn.mom {
            background: #ec4899;
            color: white;
        }
        
        .parent-btn.dad {
            background: #2563eb;
            color: white;
        }
        
        .parent-btn.inactive {
            background: #f3f4f6;
            color: #4b5563;
        }
        
        .main-content {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            background: #f3f4f6;
            color: #4b5563;
        }
        
        .tab.active {
            background: #2563eb;
            color: white;
        }
        
        .form-container {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        
        .lab-result-card {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Collaboration Header -->
    <div class="collab-header">
        <div class="collab-info">
            <div class="room-info">
                <span>üè• Collaborative Health Tracker</span>
                <div class="room-code" id="roomCode">Room: LOADING</div>
                <button class="btn" style="background: rgba(255,255,255,0.2);" onclick="copyRoomLink()">
                    üìã Copy Link
                </button>
            </div>
            <div class="user-info">
                <span id="userName">Guest</span>
                <div class="user-avatar" id="userAvatar">G</div>
                <button class="btn" style="background: rgba(255,255,255,0.2);" onclick="showUserSettings()">
                    ‚öôÔ∏è Settings
                </button>
            </div>
            <div class="active-users" id="activeUsers">
                <!-- Active users will be displayed here -->
            </div>
        </div>
    </div>
    
    <!-- Activity Feed -->
    <div class="activity-toggle shifted" id="activityToggle" onclick="toggleActivityFeed()">
        üìä Activity
    </div>
    <div class="activity-feed collapsed" id="activityFeed">
        <div class="activity-header">
            <strong>Activity Feed</strong>
            <button onclick="toggleActivityFeed()" style="background: none; border: none; cursor: pointer;">√ó</button>
        </div>
        <div class="activity-list" id="activityList">
            <!-- Activities will appear here -->
        </div>
    </div>
    
    <div class="container">
        <!-- Main Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h1 id="appTitle">Parent Health Tracker</h1>
                    <p id="appSubtitle">Comprehensive lab results and health monitoring</p>
                </div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn btn-purple" onclick="showSettings()">
                        ‚öôÔ∏è Customize
                    </button>
                    <button class="btn btn-blue" onclick="exportToCSV()">
                        üì• Export
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Parent Selector -->
        <div class="parent-selector">
            <div class="parent-buttons">
                <button class="parent-btn mom" onclick="selectParent('mom')" id="momBtn">
                    üë© Mom
                </button>
                <button class="parent-btn inactive" onclick="selectParent('dad')" id="dadBtn">
                    üë® Dad
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')" id="dashboardTab">
                    üìä Dashboard
                </button>
                <button class="tab" onclick="switchTab('labs')" id="labsTab">
                    üß™ Lab Results
                </button>
                <button class="tab" onclick="switchTab('vitals')" id="vitalsTab">
                    ‚ù§Ô∏è Vital Signs
                </button>
                <button class="tab" onclick="switchTab('medications')" id="medicationsTab">
                    üíä Medications
                </button>
                <button class="tab" onclick="switchTab('appointments')" id="appointmentsTab">
                    üìÖ Appointments
                </button>
                <button class="tab" onclick="switchTab('notes')" id="notesTab">
                    üìù Notes
                </button>
            </div>
            
            <!-- Add New Button -->
            <button id="addNewBtn" class="btn btn-green" onclick="showAddForm()" style="display: none; margin-bottom: 1rem;">
                ‚ûï Add New
            </button>
            
            <!-- Content Area -->
            <div id="contentArea"></div>
        </div>
    </div>
    
    <!-- User Settings Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <h3>User Settings</h3>
            <div class="form-group">
                <label>Your Name</label>
                <input type="text" id="userNameInput" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label>Avatar Color</label>
                <select id="avatarColor">
                    <option value="#667eea">Purple</option>
                    <option value="#10b981">Green</option>
                    <option value="#f59e0b">Orange</option>
                    <option value="#ef4444">Red</option>
                    <option value="#3b82f6">Blue</option>
                </select>
            </div>
            <div style="margin-top: 1rem;">
                <button class="btn btn-green" onclick="saveUserSettings()">Save</button>
                <button class="btn btn-gray" onclick="closeUserModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION - CRITICAL!
        // ============================================
        // Instructions:
        // 1. Go to https://console.firebase.google.com
        // 2. Create a new project (FREE)
        // 3. Enable Realtime Database
        // 4. Copy your config here
        
        const firebaseConfig = {
            // REPLACE THESE WITH YOUR ACTUAL FIREBASE CONFIG
            apiKey: "YOUR-API-KEY-HERE",
            authDomain: "YOUR-AUTH-DOMAIN.firebaseapp.com",
            databaseURL: "https://YOUR-PROJECT.firebaseio.com",
            projectId: "YOUR-PROJECT-ID",
            storageBucket: "YOUR-PROJECT.appspot.com",
            messagingSenderId: "YOUR-SENDER-ID",
            appId: "YOUR-APP-ID"
        };
        
        // Initialize Firebase
        let database = null;
        let isFirebaseEnabled = false;
        let roomCode = null;
        let userId = null;
        let userName = 'Guest';
        let userColor = '#667eea';
        let activeUsers = {};
        let activityFeedOpen = false;
        
        // Check and initialize Firebase
        if (firebaseConfig.apiKey !== "YOUR-API-KEY-HERE") {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseEnabled = true;
                console.log("‚úÖ Firebase initialized - Multi-user collaboration enabled!");
            } catch (error) {
                console.error("Firebase initialization error:", error);
                alert("Firebase initialization failed. Using local storage mode.");
            }
        } else {
            console.warn("‚ö†Ô∏è Firebase not configured. To enable multi-user collaboration:");
            console.warn("1. Go to https://console.firebase.google.com");
            console.warn("2. Create a project and enable Realtime Database");
            console.warn("3. Copy your config and replace the placeholder in this file");
            alert("Multi-user collaboration requires Firebase setup. Currently using local storage only.");
        }
        
        // State management
        let currentParent = 'mom';
        let currentTab = 'dashboard';
        let labResults = { mom: [], dad: [] };
        let medications = { mom: [], dad: [] };
        let appointments = { mom: [], dad: [] };
        let notes = { mom: [], dad: [] };
        let vitalSigns = { mom: [], dad: [] };
        let comments = {};
        let activities = [];
        let labTemplates = {};
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeUser();
            initializeRoom();
            loadData();
            updateUI();
        });
        
        // User initialization
        function initializeUser() {
            // Get or generate user ID
            userId = localStorage.getItem('healthTrackerUserId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('healthTrackerUserId', userId);
            }
            
            // Get saved user name
            userName = localStorage.getItem('healthTrackerUserName') || 'Guest';
            userColor = localStorage.getItem('healthTrackerUserColor') || '#667eea';
            
            updateUserDisplay();
        }
        
        function updateUserDisplay() {
            document.getElementById('userName').textContent = userName;
            document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();
            document.getElementById('userAvatar').style.background = userColor;
        }
        
        // Room initialization
        function initializeRoom() {
            const urlParams = new URLSearchParams(window.location.search);
            roomCode = urlParams.get('room');
            
            if (!roomCode) {
                roomCode = generateRoomCode();
                window.history.replaceState({}, '', `?room=${roomCode}`);
            }
            
            document.getElementById('roomCode').textContent = 'Room: ' + roomCode;
            
            if (isFirebaseEnabled) {
                setupRealtimeSync();
                setupPresence();
            }
        }
        
        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }
        
        // Firebase real-time sync
        function setupRealtimeSync() {
            if (!isFirebaseEnabled) return;
            
            const dataRef = database.ref(`rooms/${roomCode}/data`);
            
            // Listen for data changes
            dataRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    labResults = data.labResults || { mom: [], dad: [] };
                    medications = data.medications || { mom: [], dad: [] };
                    appointments = data.appointments || { mom: [], dad: [] };
                    notes = data.notes || { mom: [], dad: [] };
                    vitalSigns = data.vitalSigns || { mom: [], dad: [] };
                    comments = data.comments || {};
                    labTemplates = data.labTemplates || getDefaultLabTemplates();
                    
                    updateUI();
                    showSyncNotification();
                } else {
                    // Initialize with defaults
                    labTemplates = getDefaultLabTemplates();
                    saveData();
                }
            });
            
            // Listen for activities
            const activityRef = database.ref(`rooms/${roomCode}/activities`);
            activityRef.orderByChild('timestamp').limitToLast(20).on('child_added', (snapshot) => {
                const activity = snapshot.val();
                if (activity && activity.userId !== userId) {
                    addActivityToFeed(activity);
                }
            });
        }
        
        // Presence management
        function setupPresence() {
            if (!isFirebaseEnabled) return;
            
            const userRef = database.ref(`rooms/${roomCode}/users/${userId}`);
            const allUsersRef = database.ref(`rooms/${roomCode}/users`);
            
            // Set user as online
            userRef.set({
                name: userName,
                color: userColor,
                online: true,
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Update user info when changed
            userRef.update({
                name: userName,
                color: userColor
            });
            
            // Remove user when they disconnect
            userRef.onDisconnect().update({
                online: false,
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Listen for user changes
            allUsersRef.on('value', (snapshot) => {
                activeUsers = snapshot.val() || {};
                updateActiveUsers();
            });
        }
        
        function updateActiveUsers() {
            const container = document.getElementById('activeUsers');
            const onlineUsers = Object.values(activeUsers).filter(u => u.online);
            
            let html = `<span style="margin-right: 0.5rem;">üë• ${onlineUsers.length} online:</span>`;
            
            onlineUsers.forEach(user => {
                html += `
                    <div class="active-user" style="background: ${user.color};" title="${user.name}">
                        ${user.name.charAt(0).toUpperCase()}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Activity logging
        function logActivity(action, details) {
            if (!isFirebaseEnabled) return;
            
            const activity = {
                userId: userId,
                userName: userName,
                action: action,
                details: details,
                timestamp: Date.now()
            };
            
            // Save to Firebase
            database.ref(`rooms/${roomCode}/activities`).push(activity);
            
            // Add to local feed
            addActivityToFeed(activity);
        }
        
        function addActivityToFeed(activity) {
            const list = document.getElementById('activityList');
            const time = new Date(activity.timestamp).toLocaleTimeString();
            
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `
                <div class="activity-user">${activity.userName}</div>
                <div>${activity.action}</div>
                <div class="activity-time">${time}</div>
            `;
            
            list.insertBefore(item, list.firstChild);
            
            // Keep only last 20 activities
            while (list.children.length > 20) {
                list.removeChild(list.lastChild);
            }
            
            // Flash the activity button if feed is closed
            if (!activityFeedOpen) {
                const toggle = document.getElementById('activityToggle');
                toggle.style.background = '#ef4444';
                setTimeout(() => {
                    toggle.style.background = '#667eea';
                }, 1000);
            }
        }
        
        function toggleActivityFeed() {
            activityFeedOpen = !activityFeedOpen;
            document.getElementById('activityFeed').classList.toggle('collapsed');
            document.getElementById('activityToggle').classList.toggle('shifted');
        }
        
        // User settings
        function showUserSettings() {
            document.getElementById('userModal').classList.add('show');
            document.getElementById('userNameInput').value = userName;
            document.getElementById('avatarColor').value = userColor;
        }
        
        function saveUserSettings() {
            userName = document.getElementById('userNameInput').value || 'Guest';
            userColor = document.getElementById('avatarColor').value;
            
            localStorage.setItem('healthTrackerUserName', userName);
            localStorage.setItem('healthTrackerUserColor', userColor);
            
            updateUserDisplay();
            
            if (isFirebaseEnabled) {
                database.ref(`rooms/${roomCode}/users/${userId}`).update({
                    name: userName,
                    color: userColor
                });
            }
            
            closeUserModal();
            logActivity('Updated profile', `Name: ${userName}`);
        }
        
        function closeUserModal() {
            document.getElementById('userModal').classList.remove('show');
        }
        
        // Copy room link
        function copyRoomLink() {
            const link = window.location.href;
            navigator.clipboard.writeText(link);
            
            const notification = document.createElement('div');
            notification.style = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #10b981; color: white; padding: 1rem 2rem; border-radius: 0.5rem; z-index: 2000;';
            notification.textContent = '‚úÖ Room link copied! Share with others to collaborate.';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
        
        // Comments functionality
        function addComment(recordType, recordId, comment) {
            if (!comment) return;
            
            const commentObj = {
                id: Date.now(),
                userId: userId,
                userName: userName,
                text: comment,
                timestamp: Date.now()
            };
            
            if (!comments[recordType]) comments[recordType] = {};
            if (!comments[recordType][recordId]) comments[recordType][recordId] = [];
            
            comments[recordType][recordId].push(commentObj);
            saveData();
            
            logActivity('Added comment', `on ${recordType}`);
        }
        
        function showComments(recordType, recordId) {
            if (!comments[recordType] || !comments[recordType][recordId]) return '';
            
            let html = '<div class="comment-section"><h4>Comments</h4>';
            
            comments[recordType][recordId].forEach(comment => {
                const time = new Date(comment.timestamp).toLocaleString();
                html += `
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">${comment.userName}</span>
                            <span class="comment-time">${time}</span>
                        </div>
                        <div>${comment.text}</div>
                    </div>
                `;
            });
            
            html += `
                <div class="comment-input">
                    <input type="text" id="comment-${recordType}-${recordId}" placeholder="Add a comment...">
                    <button class="btn btn-blue" onclick="submitComment('${recordType}', ${recordId})">Send</button>
                </div>
            </div>`;
            
            return html;
        }
        
        function submitComment(recordType, recordId) {
            const input = document.getElementById(`comment-${recordType}-${recordId}`);
            if (input && input.value) {
                addComment(recordType, recordId, input.value);
                input.value = '';
                updateUI();
            }
        }
        
        // Notifications
        function showSyncNotification() {
            const notification = document.createElement('div');
            notification.style = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; z-index: 2000; animation: slideDown 0.3s;';
            notification.innerHTML = 'üîÑ Data synchronized';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 1500);
        }
        
        function showSaveNotification() {
            const notification = document.createElement('div');
            notification.style = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; z-index: 2000; animation: slideDown 0.3s;';
            notification.innerHTML = 'üíæ Changes saved by ' + userName;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 1500);
        }
        
        // Data operations
        function loadData() {
            if (isFirebaseEnabled) {
                // Firebase handles loading through listeners
            } else {
                // Load from localStorage
                try {
                    const saved = localStorage.getItem('healthTrackerData');
                    if (saved) {
                        const data = JSON.parse(saved);
                        labResults = data.labResults || { mom: [], dad: [] };
                        medications = data.medications || { mom: [], dad: [] };
                        appointments = data.appointments || { mom: [], dad: [] };
                        notes = data.notes || { mom: [], dad: [] };
                        vitalSigns = data.vitalSigns || { mom: [], dad: [] };
                        comments = data.comments || {};
                        labTemplates = data.labTemplates || getDefaultLabTemplates();
                    } else {
                        labTemplates = getDefaultLabTemplates();
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    labTemplates = getDefaultLabTemplates();
                }
                updateUI();
            }
        }
        
        function saveData() {
            if (isFirebaseEnabled) {
                const dataRef = database.ref(`rooms/${roomCode}/data`);
                dataRef.set({
                    labResults,
                    medications,
                    appointments,
                    notes,
                    vitalSigns,
                    comments,
                    labTemplates,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP,
                    lastUpdatedBy: userName
                });
                showSaveNotification();
            } else {
                // Save to localStorage
                try {
                    localStorage.setItem('healthTrackerData', JSON.stringify({
                        labResults,
                        medications,
                        appointments,
                        notes,
                        vitalSigns,
                        comments,
                        labTemplates
                    }));
                } catch (error) {
                    console.error('Error saving data:', error);
                }
            }
        }
        
        // Default lab templates
        function getDefaultLabTemplates() {
            return {
                'Complete Blood Count (CBC)': [
                    { name: 'WBC', unit: 'K/uL', refMin: 4.5, refMax: 11.0 },
                    { name: 'RBC', unit: 'M/uL', refMin: 4.5, refMax: 5.9 },
                    { name: 'Hemoglobin', unit: 'g/dL', refMin: 13.5, refMax: 17.5 },
                    { name: 'Hematocrit', unit: '%', refMin: 38.8, refMax: 50.0 },
                    { name: 'Platelets', unit: 'K/uL', refMin: 150, refMax: 400 }
                ],
                'Metabolic Panel': [
                    { name: 'Glucose', unit: 'mg/dL', refMin: 70, refMax: 100 },
                    { name: 'BUN', unit: 'mg/dL', refMin: 7, refMax: 20 },
                    { name: 'Creatinine', unit: 'mg/dL', refMin: 0.7, refMax: 1.3 },
                    { name: 'eGFR', unit: 'mL/min', refMin: 60, refMax: 120 }
                ],
                'Lipid Panel': [
                    { name: 'Total Cholesterol', unit: 'mg/dL', refMin: 0, refMax: 200 },
                    { name: 'LDL', unit: 'mg/dL', refMin: 0, refMax: 100 },
                    { name: 'HDL', unit: 'mg/dL', refMin: 40, refMax: 999 },
                    { name: 'Triglycerides', unit: 'mg/dL', refMin: 0, refMax: 150 }
                ]
            };
        }
        
        // UI Functions
        function selectParent(parent) {
            currentParent = parent;
            document.getElementById('momBtn').className = parent === 'mom' ? 'parent-btn mom' : 'parent-btn inactive';
            document.getElementById('dadBtn').className = parent === 'dad' ? 'parent-btn dad' : 'parent-btn inactive';
            updateUI();
            logActivity('Switched to', parent === 'mom' ? "Mom's data" : "Dad's data");
        }
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            
            const addBtn = document.getElementById('addNewBtn');
            if (tab !== 'dashboard') {
                addBtn.style.display = 'block';
            } else {
                addBtn.style.display = 'none';
            }
            
            updateUI();
        }
        
        function updateUI() {
            const contentArea = document.getElementById('contentArea');
            
            switch(currentTab) {
                case 'dashboard':
                    showDashboard();
                    break;
                case 'labs':
                    showLabResults();
                    break;
                case 'vitals':
                    showVitalSigns();
                    break;
                case 'medications':
                    showMedications();
                    break;
                case 'appointments':
                    showAppointments();
                    break;
                case 'notes':
                    showNotes();
                    break;
            }
        }
        
        function showDashboard() {
            const labs = labResults[currentParent];
            const meds = medications[currentParent];
            const vitals = vitalSigns[currentParent] || [];
            const apts = appointments[currentParent];
            
            let html = `
                <h2>Dashboard for ${currentParent === 'mom' ? 'Mom' : 'Dad'}</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <div style="background: #dbeafe; padding: 1rem; border-radius: 0.5rem;">
                        <div style="font-size: 0.875rem; color: #1e40af;">Lab Tests</div>
                        <div style="font-size: 2rem; font-weight: bold;">${labs.length}</div>
                    </div>
                    <div style="background: #fce7f3; padding: 1rem; border-radius: 0.5rem;">
                        <div style="font-size: 0.875rem; color: #9f1239;">Vital Signs</div>
                        <div style="font-size: 2rem; font-weight: bold;">${vitals.length}</div>
                    </div>
                    <div style="background: #d1fae5; padding: 1rem; border-radius: 0.5rem;">
                        <div style="font-size: 0.875rem; color: #065f46;">Medications</div>
                        <div style="font-size: 2rem; font-weight: bold;">${meds.length}</div>
                    </div>
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem;">
                        <div style="font-size: 0.875rem; color: #92400e;">Appointments</div>
                        <div style="font-size: 2rem; font-weight: bold;">${apts.length}</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 2rem;">Recent Activity</h3>
                <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                    ${getRecentActivity()}
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = html;
        }
        
        function getRecentActivity() {
            let activities = [];
            
            // Get recent labs
            labResults[currentParent].slice(-3).forEach(lab => {
                activities.push({
                    type: 'Lab',
                    date: lab.date,
                    text: `Lab test: ${lab.testType}`
                });
            });
            
            // Get recent appointments
            appointments[currentParent].slice(-3).forEach(apt => {
                activities.push({
                    type: 'Appointment',
                    date: apt.date,
                    text: `Appointment with ${apt.doctor}`
                });
            });
            
            if (activities.length === 0) {
                return '<p style="color: #6b7280;">No recent activity</p>';
            }
            
            // Sort by date
            activities.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            return activities.map(a => `
                <div style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">
                    <strong>${a.type}</strong>: ${a.text}
                    <span style="float: right; color: #6b7280;">${a.date}</span>
                </div>
            `).join('');
        }
        
        function showLabResults() {
            const labs = labResults[currentParent];
            let html = '<h2>Lab Results</h2>';
            
            if (labs.length === 0) {
                html += '<div class="empty-state">No lab results yet</div>';
            } else {
                labs.forEach(lab => {
                    html += `
                        <div class="lab-result-card">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                <div>
                                    <strong>${lab.testType}</strong>
                                    <div style="color: #6b7280; font-size: 0.875rem;">${lab.date}</div>
                                    ${lab.appointmentId ? `<div style="color: #667eea; font-size: 0.75rem;">üìÖ Linked to appointment</div>` : ''}
                                </div>
                                <div>
                                    <button class="btn btn-blue" onclick="editLab(${lab.id})" style="font-size: 0.75rem;">Edit</button>
                                    <button class="btn btn-red" onclick="deleteLab(${lab.id})" style="font-size: 0.75rem;">Delete</button>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
                                ${lab.results.map(r => `
                                    <div style="background: ${r.value < r.refMin || r.value > r.refMax ? '#fee2e2' : '#d1fae5'}; padding: 0.5rem; border-radius: 0.25rem;">
                                        <strong>${r.name}</strong>: ${r.value} ${r.unit}
                                        <div style="font-size: 0.75rem; color: #6b7280;">Ref: ${r.refMin}-${r.refMax}</div>
                                    </div>
                                `).join('')}
                            </div>
                            ${showComments('lab', lab.id)}
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }
        
        function showVitalSigns() {
            const vitals = vitalSigns[currentParent] || [];
            let html = '<h2>Vital Signs</h2>';
            
            if (vitals.length === 0) {
                html += '<div class="empty-state">No vital signs recorded yet</div>';
            } else {
                vitals.forEach(vital => {
                    html += `
                        <div class="lab-result-card">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                <div>
                                    <strong>Vital Signs Record</strong>
                                    <div style="color: #6b7280; font-size: 0.875rem;">${vital.date} ${vital.time}</div>
                                </div>
                                <div>
                                    <button class="btn btn-red" onclick="deleteVital(${vital.id})" style="font-size: 0.75rem;">Delete</button>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
                                ${vital.bloodPressureSystolic ? `<div>BP: ${vital.bloodPressureSystolic}/${vital.bloodPressureDiastolic} mmHg</div>` : ''}
                                ${vital.heartRate ? `<div>HR: ${vital.heartRate} bpm</div>` : ''}
                                ${vital.temperature ? `<div>Temp: ${vital.temperature}¬∞C</div>` : ''}
                                ${vital.oxygenSat ? `<div>O2: ${vital.oxygenSat}%</div>` : ''}
                            </div>
                            ${showComments('vital', vital.id)}
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }
        
        function showMedications() {
            const meds = medications[currentParent];
            let html = '<h2>Medications</h2>';
            
            if (meds.length === 0) {
                html += '<div class="empty-state">No medications added yet</div>';
            } else {
                meds.forEach(med => {
                    html += `
                        <div class="lab-result-card">
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <strong>${med.name}</strong>
                                    <div>${med.dosage} - ${med.frequency}</div>
                                    <div style="color: #6b7280; font-size: 0.875rem;">Take at ${med.time}</div>
                                </div>
                                <button class="btn btn-red" onclick="deleteMed(${med.id})" style="font-size: 0.75rem;">Delete</button>
                            </div>
                            ${showComments('medication', med.id)}
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }
        
        function showAppointments() {
            const apts = appointments[currentParent];
            let html = '<h2>Appointments</h2>';
            
            if (apts.length === 0) {
                html += '<div class="empty-state">No appointments scheduled</div>';
            } else {
                apts.forEach(apt => {
                    html += `
                        <div class="lab-result-card">
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <strong>${apt.type}</strong>
                                    <div>Dr. ${apt.doctor}</div>
                                    <div style="color: #6b7280; font-size: 0.875rem;">${apt.date}</div>
                                    ${apt.linkedLabId ? `<div style="color: #10b981; font-size: 0.75rem;">‚úÖ Lab results linked</div>` : ''}
                                </div>
                                <button class="btn btn-red" onclick="deleteApt(${apt.id})" style="font-size: 0.75rem;">Delete</button>
                            </div>
                            ${showComments('appointment', apt.id)}
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }
        
        function showNotes() {
            const notesList = notes[currentParent];
            let html = '<h2>Notes</h2>';
            
            if (notesList.length === 0) {
                html += '<div class="empty-state">No notes added yet</div>';
            } else {
                notesList.forEach(note => {
                    html += `
                        <div class="lab-result-card">
                            <strong>${note.title}</strong>
                            <div style="color: #6b7280; font-size: 0.875rem;">${note.category}</div>
                            <div style="margin-top: 0.5rem;">${note.content}</div>
                            <div style="color: #9ca3af; font-size: 0.75rem; margin-top: 0.5rem;">
                                ${new Date(note.timestamp).toLocaleString()}
                            </div>
                            ${showComments('note', note.id)}
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }
        
        // Add forms
        function showAddForm() {
            let html = '<div class="form-container">';
            
            switch(currentTab) {
                case 'labs':
                    html += `
                        <h3>Add Lab Result</h3>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="labDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>Test Type</label>
                            <select id="labType">
                                ${Object.keys(labTemplates).map(type => `<option>${type}</option>`).join('')}
                            </select>
                        </div>
                        <div id="labTests"></div>
                        <button class="btn btn-green" onclick="saveLab()">Save Lab Result</button>
                    `;
                    break;
                    
                case 'vitals':
                    html += `
                        <h3>Add Vital Signs</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="vitalDate" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label>Time</label>
                                <input type="time" id="vitalTime" value="${new Date().toTimeString().slice(0,5)}">
                            </div>
                            <div class="form-group">
                                <label>BP Systolic</label>
                                <input type="number" id="bpSys" placeholder="120">
                            </div>
                            <div class="form-group">
                                <label>BP Diastolic</label>
                                <input type="number" id="bpDia" placeholder="80">
                            </div>
                            <div class="form-group">
                                <label>Heart Rate</label>
                                <input type="number" id="hr" placeholder="70">
                            </div>
                            <div class="form-group">
                                <label>Temperature (¬∞C)</label>
                                <input type="number" step="0.1" id="temp" placeholder="36.5">
                            </div>
                            <div class="form-group">
                                <label>O2 Saturation (%)</label>
                                <input type="number" id="o2" placeholder="98">
                            </div>
                        </div>
                        <button class="btn btn-green" onclick="saveVital()">Save Vital Signs</button>
                    `;
                    break;
                    
                case 'medications':
                    html += `
                        <h3>Add Medication</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Medication Name</label>
                                <input type="text" id="medName">
                            </div>
                            <div class="form-group">
                                <label>Dosage</label>
                                <input type="text" id="medDosage" placeholder="e.g., 10mg">
                            </div>
                            <div class="form-group">
                                <label>Frequency</label>
                                <select id="medFreq">
                                    <option>Once daily</option>
                                    <option>Twice daily</option>
                                    <option>Three times daily</option>
                                    <option>As needed</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Time</label>
                                <input type="time" id="medTime" value="08:00">
                            </div>
                        </div>
                        <button class="btn btn-green" onclick="saveMed()">Save Medication</button>
                    `;
                    break;
                    
                case 'appointments':
                    html += `
                        <h3>Add Appointment</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Date</label>
                                <input type="datetime-local" id="aptDate">
                            </div>
                            <div class="form-group">
                                <label>Doctor</label>
                                <input type="text" id="aptDoctor">
                            </div>
                            <div class="form-group">
                                <label>Type</label>
                                <input type="text" id="aptType" placeholder="e.g., Checkup">
                            </div>
                        </div>
                        <button class="btn btn-green" onclick="saveApt()">Save Appointment</button>
                    `;
                    break;
                    
                case 'notes':
                    html += `
                        <h3>Add Note</h3>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="noteTitle">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="noteCategory">
                                <option>General</option>
                                <option>Symptoms</option>
                                <option>Diet</option>
                                <option>Exercise</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Content</label>
                            <textarea id="noteContent" rows="4"></textarea>
                        </div>
                        <button class="btn btn-green" onclick="saveNote()">Save Note</button>
                    `;
                    break;
            }
            
            html += '<button class="btn btn-gray" onclick="updateUI()" style="margin-left: 0.5rem;">Cancel</button>';
            html += '</div>';
            
            document.getElementById('contentArea').innerHTML = html;
            
            if (currentTab === 'labs') {
                updateLabTests();
            }
        }
        
        function updateLabTests() {
            const type = document.getElementById('labType').value;
            const tests = labTemplates[type] || [];
            let html = '<div style="margin-top: 1rem;">';
            
            tests.forEach((test, idx) => {
                html += `
                    <div style="margin-bottom: 0.5rem;">
                        <label>${test.name} (${test.unit})</label>
                        <input type="number" step="0.01" id="test_${idx}" placeholder="Ref: ${test.refMin}-${test.refMax}">
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('labTests').innerHTML = html;
        }
        
        // Save functions
        function saveLab() {
            const type = document.getElementById('labType').value;
            const date = document.getElementById('labDate').value;
            const tests = labTemplates[type];
            const results = [];
            
            tests.forEach((test, idx) => {
                const value = parseFloat(document.getElementById(`test_${idx}`).value);
                if (!isNaN(value)) {
                    results.push({
                        name: test.name,
                        value: value,
                        unit: test.unit,
                        refMin: test.refMin,
                        refMax: test.refMax
                    });
                }
            });
            
            if (results.length > 0) {
                const lab = {
                    id: Date.now(),
                    date: date,
                    testType: type,
                    results: results
                };
                
                labResults[currentParent].push(lab);
                saveData();
                updateUI();
                logActivity('Added lab result', type);
            }
        }
        
        function saveVital() {
            const vital = {
                id: Date.now(),
                date: document.getElementById('vitalDate').value,
                time: document.getElementById('vitalTime').value,
                bloodPressureSystolic: document.getElementById('bpSys').value,
                bloodPressureDiastolic: document.getElementById('bpDia').value,
                heartRate: document.getElementById('hr').value,
                temperature: document.getElementById('temp').value,
                oxygenSat: document.getElementById('o2').value
            };
            
            if (!vitalSigns[currentParent]) vitalSigns[currentParent] = [];
            vitalSigns[currentParent].push(vital);
            saveData();
            updateUI();
            logActivity('Added vital signs', 'Record');
        }
        
        function saveMed() {
            const med = {
                id: Date.now(),
                name: document.getElementById('medName').value,
                dosage: document.getElementById('medDosage').value,
                frequency: document.getElementById('medFreq').value,
                time: document.getElementById('medTime').value
            };
            
            if (med.name) {
                medications[currentParent].push(med);
                saveData();
                updateUI();
                logActivity('Added medication', med.name);
            }
        }
        
        function saveApt() {
            const apt = {
                id: Date.now(),
                date: document.getElementById('aptDate').value,
                doctor: document.getElementById('aptDoctor').value,
                type: document.getElementById('aptType').value
            };
            
            if (apt.doctor && apt.type) {
                appointments[currentParent].push(apt);
                saveData();
                updateUI();
                logActivity('Added appointment', apt.type);
            }
        }
        
        function saveNote() {
            const note = {
                id: Date.now(),
                title: document.getElementById('noteTitle').value,
                category: document.getElementById('noteCategory').value,
                content: document.getElementById('noteContent').value,
                timestamp: Date.now()
            };
            
            if (note.title && note.content) {
                notes[currentParent].push(note);
                saveData();
                updateUI();
                logActivity('Added note', note.title);
            }
        }
        
        // Delete functions
        function deleteLab(id) {
            if (confirm('Delete this lab result?')) {
                labResults[currentParent] = labResults[currentParent].filter(l => l.id !== id);
                saveData();
                updateUI();
                logActivity('Deleted lab result', '');
            }
        }
        
        function deleteVital(id) {
            if (confirm('Delete this vital sign record?')) {
                vitalSigns[currentParent] = vitalSigns[currentParent].filter(v => v.id !== id);
                saveData();
                updateUI();
                logActivity('Deleted vital signs', '');
            }
        }
        
        function deleteMed(id) {
            if (confirm('Delete this medication?')) {
                medications[currentParent] = medications[currentParent].filter(m => m.id !== id);
                saveData();
                updateUI();
                logActivity('Deleted medication', '');
            }
        }
        
        function deleteApt(id) {
            if (confirm('Delete this appointment?')) {
                appointments[currentParent] = appointments[currentParent].filter(a => a.id !== id);
                saveData();
                updateUI();
                logActivity('Deleted appointment', '');
            }
        }
        
        // Settings
        function showSettings() {
            alert('Settings panel - Add custom lab tests, units, and reference ranges here');
        }
        
        // Export
        function exportToCSV() {
            let csv = `Parent Health Data Export\nGenerated: ${new Date().toLocaleString()}\n\n`;
            
            // Add lab results
            csv += 'LAB RESULTS\n';
            csv += 'Date,Type,Test,Value,Unit,Min,Max\n';
            labResults[currentParent].forEach(lab => {
                lab.results.forEach(r => {
                    csv += `${lab.date},${lab.testType},${r.name},${r.value},${r.unit},${r.refMin},${r.refMax}\n`;
                });
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `health_data_${currentParent}_${Date.now()}.csv`;
            a.click();
            
            logActivity('Exported data', 'CSV');
        }
    </script>
</body>
</html>
